<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Travel Vibe âœˆï¸ æ—…ç¨‹è¦åŠƒ</title>
    <meta property="og:title" content="Travel Vibe âœˆï¸ æ—…ç¨‹è¦åŠƒ">
    <meta property="og:description" content="é»æ“ŠæŸ¥çœ‹è©³ç´°è¡Œç¨‹å®‰æ’">

    <!-- å¼•å…¥ SortableJS å¯¦ç¾æ‹–æ‹‰åŠŸèƒ½ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    
    <!-- å¼•å…¥ Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, collection, query, orderBy, limit, getDocs, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // ==========================================
        // â˜…â˜…â˜… 1. è«‹å°‡ä½ çš„ Firebase Config è²¼åœ¨ä¸‹æ–¹ â˜…â˜…â˜…
        // ==========================================
        const firebaseConfig = {
            apiKey: "AIzaSyBOjKc027UOSZRV3ao5l8-33bQGPZ3pBYM",
            authDomain: "traveling-85185.firebaseapp.com",
            projectId: "traveling-85185",
            storageBucket: "traveling-85185.firebasestorage.app",
            messagingSenderId: "178405000657",
            appId: "1:178405000657:web:687bb52bae2151bc7e0cf0",
            measurementId: "G-7QWLJ42T9W"
        };

        // ==========================================
        // â˜…â˜…â˜… 2. å›ºå®šè¡Œç¨‹ ID (é¸å¡«) â˜…â˜…â˜…
        // ==========================================
        const PRESET_TRIP_ID = ""; 

        // ==========================================
        // â˜…â˜…â˜… 3. ç®¡ç†å“¡å¯†ç¢¼ (ç·¨è¼¯æ¬Šé™é–) â˜…â˜…â˜…
        // ==========================================
        const ADMIN_PASSWORD = "MM1234567890"; // â† è«‹ä¿®æ”¹æ­¤å¯†ç¢¼

        // --- Firebase åˆå§‹åŒ–é‚è¼¯ ---
        if (!firebaseConfig || !firebaseConfig.projectId) {
            document.addEventListener('DOMContentLoaded', () => {
                const overlay = document.getElementById('loading-overlay');
                if(overlay) {
                    overlay.innerHTML = `<div style="background:white;padding:30px;border-radius:12px;text-align:center;"><h2>å°šæœªè¨­å®š Firebase</h2><p>è«‹ç·¨è¼¯ HTML æª”æ¡ˆå¡«å…¥è¨­å®šã€‚</p></div>`;
                }
            });
            throw new Error("Firebase Config is missing");
        }

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        window.firebaseModules = { 
            db, auth, doc, getDoc, setDoc, signInAnonymously, onAuthStateChanged, ADMIN_PASSWORD,
            collection, query, orderBy, limit, getDocs, deleteDoc 
        };
        window.dispatchEvent(new Event('firebase-ready'));
    </script>

    <style>
        :root {
            /* ç™½è‰²ç³»æ¥µç°¡é…è‰² */
            --bg-gradient: linear-gradient(135deg, #fdfbfb 0%, #ebedee 100%);
            --card-bg: rgba(255, 255, 255, 0.95);
            --glass-border: 1px solid rgba(0, 0, 0, 0.05);
            --text-color: #2d3436;
            --accent-color: #0984e3; /* å†°å³¶è— */
            --accent-hover: #74b9ff;
            --sub-text: #636e72;
            --input-bg: #f5f6fa;
            --sidebar-bg: rgba(241, 242, 246, 0.8);
            --danger-color: #d63031;
            --warning-color: #f39c12;
            --info-color: #00cec9;
        }

        body {
            font-family: 'Noto Sans TC', 'Segoe UI', system-ui, -apple-system, sans-serif;
            background: var(--bg-gradient);
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            color: var(--text-color);
            display: flex;
            justify-content: center;
            align-items: flex-start;
            transition: all 0.3s;
        }

        /* Loading Overlay */
        #loading-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(255,255,255,0.95); z-index: 9999;
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            font-weight: bold; color: var(--accent-color);
        }
        .spinner {
            width: 40px; height: 40px; border: 4px solid #eee;
            border-top: 4px solid var(--accent-color); border-radius: 50%;
            animation: spin 1s linear infinite; margin-bottom: 15px;
        }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* Toast Notification */
        #toast {
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.8); color: white; padding: 10px 25px;
            border-radius: 50px; font-size: 0.9rem; opacity: 0;
            transition: opacity 0.3s; pointer-events: none; z-index: 10000;
        }
        #toast.show { opacity: 1; }

        .container {
            width: 100%;
            max-width: 1100px;
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 24px;
            border: var(--glass-border);
            padding: 0;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.08);
            overflow: hidden;
            position: relative;
            display: flex;
            flex-direction: column;
        }

        /* æ©«å¹…åœ–ç‰‡å€åŸŸ */
        .banner {
            width: 100%;
            height: 180px;
            position: relative;
            overflow: hidden;
            flex-shrink: 0;
            cursor: pointer;
            group: banner;
        }

        .banner img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 10s ease, filter 0.3s;
        }
        
        .banner:hover img {
            transform: scale(1.05);
            filter: brightness(0.8);
        }

        /* å°é¢ç·¨è¼¯æç¤º */
        .banner-edit-hint {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(0, 0, 0, 0.5);
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .banner:hover .banner-edit-hint {
            opacity: 1;
        }

        .banner-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to top, rgba(0,0,0,0.7), transparent);
            padding: 20px 30px;
            pointer-events: none;
        }

        h1 {
            font-weight: 800;
            font-size: 2rem;
            margin: 0;
            color: #fff;
            text-shadow: 0 2px 5px rgba(0,0,0,0.3);
            letter-spacing: 1px;
            pointer-events: auto;
            cursor: pointer;
            display: inline-block;
            transition: all 0.2s;
            padding: 2px 10px;
            border-radius: 8px;
        }

        h1:hover {
            background: rgba(255, 255, 255, 0.2);
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
        }

        h1::after {
            content: 'âœ';
            font-size: 1.2rem;
            margin-left: 10px;
            opacity: 0;
            transition: opacity 0.2s;
            vertical-align: middle;
        }

        h1:hover::after { opacity: 1; }

        /* å…§å®¹å€å¡Šä½ˆå±€ */
        .content-wrapper {
            display: flex;
            min-height: 600px;
            position: relative;
        }

        /* å·¦å´å°è¦½åˆ— */
        .sidebar {
            width: 160px;
            background: var(--sidebar-bg);
            border-right: 1px solid rgba(0,0,0,0.05);
            padding: 20px 0;
            display: flex;
            flex-direction: column;
            gap: 5px;
            flex-shrink: 0;
            overflow-y: auto; 
        }

        /* å´é‚Šæ¬„æŒ‰éˆ•å®¹å™¨ - ç”¨æ–¼ Sortable */
        #daySidebarList {
            display: flex;
            flex-direction: column;
            gap: 5px;
            width: 100%;
        }

        .sidebar-btn {
            padding: 12px 0;
            text-align: center;
            cursor: pointer;
            font-weight: 600;
            color: var(--sub-text);
            transition: all 0.2s;
            border: none;
            background: transparent;
            width: 100%;
            font-family: inherit;
            font-size: 0.9rem;
            position: relative;
            user-select: none; 
            cursor: grab; 
        }

        .sidebar-btn:active {
            cursor: grabbing;
        }

        .sidebar-btn:hover {
            color: var(--accent-color);
            background: rgba(255,255,255,0.5);
        }

        .sidebar-btn.active {
            background: #fff;
            color: var(--accent-color);
            font-weight: 800;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        
        .sidebar-btn.active::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            background: var(--accent-color);
        }

        .sidebar-btn.static-btn {
            cursor: pointer; 
            border-bottom: 1px solid rgba(0,0,0,0.05);
            margin-bottom: 5px;
        }

        .sidebar-sortable-ghost {
            opacity: 0.4;
            background: #dfe6e9;
            border: 1px dashed #b2bec3;
        }
        
        .sidebar-sortable-drag {
            background: #fff;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transform: scale(1.05);
            z-index: 999;
        }

        .sidebar-controls {
            margin-top: 20px;
            padding: 0 10px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            align-items: center;
            border-top: 1px solid rgba(0,0,0,0.05);
            padding-top: 15px;
        }

        .day-controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 5px;
        }

        .control-btn {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: 1px solid #ddd;
            background: #fff;
            color: var(--sub-text);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            transition: all 0.2s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .control-btn:hover {
            border-color: var(--accent-color);
            color: var(--accent-color);
            transform: scale(1.1);
        }

        .action-btn {
            width: 100%;
            padding: 8px;
            border-radius: 8px;
            background: #fff;
            border: 1px solid #ddd;
            cursor: pointer;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            color: var(--sub-text);
            transition: all 0.2s;
        }

        .action-btn:hover {
            background: #f1f2f6;
            color: #2d3436;
        }
        
        .share-btn {
            background: #e3f2fd;
            border-color: #bbdefb;
            color: #1976d2;
            font-weight: bold;
        }
        .share-btn:hover {
            background: #2196f3;
            color: white;
            border-color: #2196f3;
        }
        
        .new-trip-btn {
            background: #6c5ce7;
            color: white;
            border-color: #6c5ce7;
            font-weight: bold;
            margin-bottom: 10px;
        }
        .new-trip-btn:hover { background: #a29bfe; border-color: #a29bfe; color: white; }

        .trip-list-btn {
            background: #00cec9;
            color: white;
            border-color: #00cec9;
            font-weight: bold;
        }
        .trip-list-btn:hover { background: #81ecec; border-color: #81ecec; color: white; }

        .lock-btn:hover { background: #f1f2f6; }
        .lock-btn.active {
            background: #fff3e0;
            color: #e67e22;
            border-color: #ffe0b2;
            font-weight: bold;
        }

        .clear-btn {
            background: #fff0f0;
            border-color: #ffcccc;
            color: var(--danger-color);
        }
        .clear-btn:hover {
            background: var(--danger-color);
            color: white;
            border-color: var(--danger-color);
        }

        .reset-btn {
            background: #f0f0f0;
            border-color: #ddd;
            color: #636e72;
            font-size: 0.8rem;
        }
        .reset-btn:hover {
            background: #636e72;
            color: white;
            border-color: #636e72;
        }

        /* --- å³å´ä¸»å…§å®¹å€ (åˆ†å‰²ä½ˆå±€) --- */
        .main-panel {
            flex: 1;
            padding: 25px;
            background: rgba(255,255,255,0.4);
            overflow-y: hidden; /* é˜²æ­¢é›™é‡æ²è»¸ */
            display: flex;
            flex-direction: column;
        }

        /* æ–°å¢ï¼šå…§éƒ¨ Flex å®¹å™¨ï¼Œåˆ†å·¦å³å…©æ¬„ */
        .main-panel-content {
            display: flex;
            gap: 20px;
            height: 100%;
            overflow: hidden;
            min-height: 500px;
        }

        /* å·¦é‚Šï¼šè¡Œç¨‹åˆ—è¡¨ */
        .timeline-wrapper {
            flex: 1;
            overflow-y: auto;
            padding-right: 5px;
            min-width: 0; /* é˜²æ­¢ Flex å­å…ƒç´ æº¢å‡º */
        }

        /* å³é‚Šï¼šåœ°åœ–å®¹å™¨ */
        .map-container {
            flex: 1;
            min-width: 350px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            background: #fff;
            padding: 10px;
            border-radius: 16px;
            border: 1px solid rgba(0,0,0,0.05);
            height: calc(100vh - 250px); /* è®“åœ°åœ–é«˜åº¦é©ä¸­ */
            position: sticky; /* è®“åœ°åœ–å›ºå®š */
            top: 0;
        }

        .map-frame {
            flex: 1;
            width: 100%;
            border-radius: 12px;
            background: #eee;
            border: none;
        }

        .map-btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 8px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.9rem;
            text-align: center;
        }
        .map-btn:hover { background: #2980b9; }

        .input-group {
            background: #fff;
            padding: 15px;
            border-radius: 16px;
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            border: 1px solid #eee;
            box-shadow: 0 2px 4px rgba(0,0,0,0.02);
            align-items: center;
            flex-shrink: 0;
        }

        select, input {
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            background: var(--input-bg);
            color: var(--text-color);
            outline: none;
            transition: border 0.2s;
        }

        select#dayInput { flex: 0 0 90px; }
        input[type="text"] { flex: 1; min-width: 120px; }
        button.add-btn { background: var(--accent-color); color: white; border: none; padding: 10px 20px; border-radius: 8px; font-weight: bold; cursor: pointer; }

        .day-section { margin-bottom: 30px; }
        .day-header { font-size: 1.1rem; font-weight: 700; margin-bottom: 15px; padding-bottom: 8px; border-bottom: 2px solid #eee; display: flex; align-items: center; }
        .day-badge { background: var(--text-color); color: #fff; padding: 3px 10px; border-radius: 6px; font-size: 0.8rem; margin-right: 10px; }
        
        .plan-item { background: #fff; margin-bottom: 12px; padding: 12px; border-radius: 12px; display: flex; flex-direction: column; border: 1px solid transparent; box-shadow: 0 2px 5px rgba(0,0,0,0.02); transition: all 0.2s; cursor: grab; }
        .plan-item:hover { border-color: var(--accent-color); box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        .plan-main { display: flex; align-items: center; gap: 15px; width: 100%; }
        /* â˜…â˜…â˜… æ–°å¢ï¼šé»æ“Šæ•ˆæœæ¨£å¼ â˜…â˜…â˜… */
        .plan-content { flex: 1; display: flex; flex-direction: column; justify-content: center; cursor: pointer; transition: opacity 0.2s; }
        .plan-content:hover { opacity: 0.7; }
        
        .img-container { width: 80px; height: 80px; flex-shrink: 0; margin-left: auto; position: relative; cursor: pointer; }
        .plan-img { width: 100%; height: 100%; border-radius: 10px; object-fit: cover; background: #eee; }
        .img-placeholder { width: 100%; height: 100%; border-radius: 10px; background: #f1f2f6; border: 2px dashed #d1d8e0; display: flex; align-items: center; justify-content: center; color: #a4b0be; font-size: 0.8rem; }
        .img-container:hover .edit-hint { opacity: 1; }
        .edit-hint { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: white; opacity: 0; pointer-events: none; text-shadow: 0 1px 3px rgba(0,0,0,0.5); }

        .plan-time { font-weight: 600; color: var(--accent-color); font-size: 0.85rem; margin-bottom: 4px; display: inline-block; }
        .editable-text { padding: 2px 4px; border-radius: 4px; }
        .delete-btn { background: none; border: none; color: #dfe6e9; cursor: pointer; font-size: 1.2rem; }
        .delete-btn:hover { color: #d63031; }
        
        .tag-base { padding: 2px 6px; border-radius: 4px; font-size: 0.75rem; cursor: pointer; }
        .tag-flight { background-color: #e3f2fd; color: #1565c0; }
        .tag-hotel { background-color: #e8f5e9; color: #2e7d32; }
        .tag-food { background-color: #fff3e0; color: #e67e22; }
        .tag-sightseeing { background-color: #e0f7fa; color: #0097a7; }
        .tag-none { border: 1px dashed #ccc; color: #999; font-size: 0.7rem; padding: 1px 5px; }

        .plan-meta { display: flex; align-items: center; gap: 10px; margin-top: 6px; }
        .note-toggle-btn { background: none; border: 1px solid #eee; border-radius: 12px; padding: 2px 8px; font-size: 0.75rem; color: #b2bec3; cursor: pointer; display: inline-flex; align-items: center; gap: 3px; }
        .note-toggle-btn.has-note { color: var(--accent-color); border-color: rgba(9, 132, 227, 0.2); }
        .plan-note-area { width: 100%; display: none; margin-top: 10px; padding-top: 10px; border-top: 1px dashed #f1f2f6; }
        .note-textarea { width: 100%; min-height: 60px; padding: 10px; border: 1px solid #dfe6e9; border-radius: 8px; background: #fafafa; outline: none; }

        .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); backdrop-filter: blur(5px); justify-content: center; align-items: center; }
        img.modal-content { max-width: 90%; max-height: 90vh; border-radius: 8px; box-shadow: 0 0 20px rgba(0,0,0,0.5); }
        .modal-close { position: absolute; top: 20px; right: 30px; color: #fff; font-size: 40px; cursor: pointer; font-weight: bold; }
        
        .trip-list { list-style: none; padding: 0; margin: 0; max-height: 400px; overflow-y: auto; }
        .trip-item { display: flex; justify-content: space-between; align-items: center; padding: 12px; border-bottom: 1px solid #eee; background: white; }
        .trip-item:hover { background-color: #f8f9fa; }
        .trip-link { flex: 1; cursor: pointer; }
        .trip-delete { color: #b2bec3; cursor: pointer; padding: 5px 10px; }
        .trip-delete:hover { background-color: #ffe0e0; color: #d63031; }
        .modal-box { background: white; width: 90%; max-width: 500px; border-radius: 12px; padding: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        .modal-header { font-size: 1.2rem; font-weight: bold; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; }

        body.locked-mode .input-group, body.locked-mode .delete-btn, body.locked-mode .day-controls, body.locked-mode .clear-btn, body.locked-mode .reset-btn, body.locked-mode .new-trip-btn { display: none; }
        body.locked-mode .img-container.img-empty { opacity: 0 !important; pointer-events: none; }
        body.locked-mode .banner-edit-hint { display: none; }
        body.locked-mode .note-toggle-btn:not(.has-note) { display: none; }

        @media (max-width: 800px) {
            .main-panel-content { flex-direction: column-reverse; }
            .map-container { height: 250px; position: static; margin-bottom: 20px; }
            .content-wrapper { flex-direction: column; }
            .sidebar { width: 100%; flex-direction: row; overflow-x: auto; padding: 10px; }
            #daySidebarList { flex-direction: row; }
            .sidebar-controls { flex-direction: row; border-left: 1px solid #eee; padding-left: 10px; margin-top: 0; padding-top: 0; border-top: none; }
            .action-btn { width: auto; font-size: 1rem; padding: 5px 10px; }
            .sidebar-btn { width: auto; padding: 8px 15px; white-space: nowrap; }
        }
    </style>
</head>
<body>

<div id="loading-overlay">
    <div class="spinner"></div>
    <div>æ­£åœ¨é€£ç·šé›²ç«¯è³‡æ–™åº«...</div>
</div>

<div id="toast">å·²è¤‡è£½åˆ†äº«é€£çµï¼</div>

<div class="container">
    <div class="banner" onclick="editBanner()" title="é»æ“Šæ›´æ›å°é¢åœ–ç‰‡">
        <img id="bannerImg" src="https://images.unsplash.com/photo-1476610182048-b716b8518aae?q=80&w=1000&auto=format&fit=crop" alt="Iceland Landscape">
        <div class="banner-edit-hint">ğŸ“· æ›´æ›å°é¢</div>
        <div class="banner-overlay">
            <h1 id="mainTitle" onclick="editTitle(event)" title="é»æ“Šä¿®æ”¹æ¨™é¡Œ">Travel Vibe âœˆï¸</h1>
        </div>
    </div>
    
    <div class="content-wrapper">
        <div class="sidebar" id="sidebarContainer">
            <button id="btn-all" class="sidebar-btn static-btn" onclick="switchView('all')">å…¨éƒ¨</button>
            <div id="daySidebarList"></div>
            <div class="sidebar-controls">
                <button class="action-btn new-trip-btn" onclick="createNewTrip()" title="é–‹å§‹ä¸€å€‹å…¨æ–°çš„ç©ºç™½è¡Œç¨‹">âœ¨ å»ºç«‹æ–°è¡Œç¨‹</button>
                <button class="action-btn trip-list-btn" onclick="openTripListModal()" title="æŸ¥çœ‹æ‰€æœ‰å…¬é–‹è¡Œç¨‹">ğŸ“‚ æ‰€æœ‰è¡Œç¨‹</button>

                <div class="day-controls">
                    <button class="control-btn" onclick="changeTotalDays(-1)" title="æ¸›å°‘ä¸€å¤©">ï¼</button>
                    <button class="control-btn" onclick="changeTotalDays(1)" title="å¢åŠ ä¸€å¤©">ï¼‹</button>
                </div>
                <button class="action-btn share-btn" onclick="shareTrip()" title="è¤‡è£½ç¶²å€åˆ†äº«çµ¦æœ‹å‹">ğŸ”— åˆ†äº«è¡Œç¨‹</button>
                
                <button id="lockBtn" class="action-btn lock-btn" onclick="toggleLock()" title="é–å®š/è§£é–è¡Œç¨‹">
                    <span id="lockIcon">ğŸ”“</span> <span id="lockText" style="font-size:0.8rem">æª¢è¦–ä¸­</span>
                </button>

                <button class="action-btn clear-btn" onclick="clearAllPlans()" title="æ¸…ç©ºæ‰€æœ‰è¡Œç¨‹">ğŸ—‘ï¸ æ¸…é™¤æ‰€æœ‰è¡Œç¨‹</button>
                <button class="action-btn reset-btn" onclick="resetDefault()" title="é‚„åŸè‡³ç¯„ä¾‹è¡Œç¨‹">â†º é‡ç½®ç‚ºé è¨­</button>
            </div>
        </div>

        <div class="main-panel">
            <div class="input-group">
                <select id="dayInput"></select>
                <input type="time" id="timeInput">
                <select id="tagInput">
                    <option value="">(ç„¡æ¨™ç±¤)</option>
                    <option value="sightseeing">ğŸ”ï¸ æ™¯é»</option>
                    <option value="flight">âœˆï¸ èˆªç­</option>
                    <option value="hotel">ğŸ¨ ä½å®¿</option>
                    <option value="food">ğŸ½ï¸ ç¾é£Ÿ</option>
                </select>
                <input type="text" id="activityInput" placeholder="è¡Œç¨‹ (ä¾‹å¦‚: è—æ¹–æº«æ³‰)">
                <button class="add-btn" onclick="addPlan()">ï¼‹ åŠ å…¥</button>
            </div>
            
            <div class="main-panel-content">
                <div id="timeline-container" class="timeline-wrapper"></div>
                <div class="map-container">
                    <button class="map-btn" onclick="openFullMapRoute()">ğŸ—ºï¸ é–‹å•Ÿ Google Maps å®Œæ•´è·¯ç·š</button>
                    <iframe id="googleMapFrame" class="map-frame" src="about:blank" loading="lazy"></iframe>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="imageModal" class="modal" onclick="closeModal()">
    <span class="modal-close">&times;</span>
    <img class="modal-content" id="modalImg">
</div>

<div id="tripListModal" class="modal" style="z-index: 3000;">
    <div class="modal-box">
        <div class="modal-header">
            ğŸ“‚ æ‰€æœ‰å…¬é–‹è¡Œç¨‹
            <span onclick="closeTripListModal()" style="cursor:pointer; font-size:1.5rem;">&times;</span>
        </div>
        <ul id="myTripList" class="trip-list"></ul>
    </div>
</div>

<script>
    let db, auth, appId;
    let tripId = null;
    let currentUser = null;
    let saveTimeout = null;
    const STORAGE_KEY_TRIPS = 'iceland_vibe_my_trips';

    const DEFAULT_TITLE = "æˆ‘çš„æ—…éŠè¨ˆç•« âœˆï¸"; 
    const DEFAULT_BANNER = "https://images.unsplash.com/photo-1476610182048-b716b8518aae?q=80&w=1000&auto=format&fit=crop";
    
    const defaultItinerary = [
       { id: 101, day: 1, time: "08:00", activity: "TPE âœˆï¸ HKG (åœ‹æ³° CX477/495)", tag: "flight", image: "https://images.unsplash.com/photo-1436491865332-7a61a109cc05?w=200&h=200&fit=crop", note: "è¨˜å¾—ææ—©2å°æ™‚åˆ°æ©Ÿå ´å ±åˆ°" },
       { id: 102, day: 1, time: "14:55", activity: "HKG è½‰æ©Ÿ (ä¸­è½‰æ­æ´²)", tag: "flight", image: "https://images.unsplash.com/photo-1542296332-2e44a996aa0d?w=200&h=200&fit=crop" },
       { id: 103, day: 1, time: "18:00", activity: "æŠµé”å†°å³¶ KEF æ©Ÿå ´ & å–è»Š", tag: "flight", image: "https://images.unsplash.com/photo-1478131143081-80f7f84ca84d?w=200&h=200&fit=crop" },
       { id: 104, day: 1, time: "19:30", activity: "ä½å®¿ï¼šOdinsve Hotel", tag: "hotel", image: "https://images.unsplash.com/photo-1596425318727-2c18510842e3?w=200&h=200&fit=crop" },
       { id: 105, day: 1, time: "20:00", activity: "Bonus å°è±¬è¶…å¸‚ & Outlet", image: "https://images.unsplash.com/photo-1578916171728-46686eac8d58?w=200&h=200&fit=crop" },
       { id: 106, day: 1, time: "21:00", activity: "æ™šé¤ï¼šÃslenski barinn (ç‡‰ç¾Šè…¿)", tag: "food", image: "https://images.unsplash.com/photo-1514362545857-3bc16c4c7d1b?w=200&h=200&fit=crop" },
       { id: 201, day: 2, time: "09:00", activity: "BÃ¦jarins Beztu Pylsur (ç†±ç‹—å ¡)", tag: "food", image: "https://images.unsplash.com/photo-1612392166886-ee8475b03af2?w=200&h=200&fit=crop" },
       { id: 202, day: 2, time: "11:00", activity: "SkÃ³gafoss å²å¯åŠ ç€‘å¸ƒ", tag: "sightseeing", image: "https://images.unsplash.com/photo-1520690214124-2405c5217036?w=200&h=200&fit=crop" },
       { id: 203, day: 2, time: "13:30", activity: "Reynisfjara é»‘æ²™ç˜", tag: "sightseeing", image: "https://images.unsplash.com/photo-1508138221679-760a23a2285b?w=200&h=200&fit=crop" },
       { id: 204, day: 2, time: "15:00", activity: "åˆé»ï¼šThe Soup Company (ç†”å²©æ¹¯)", tag: "food", image: "https://images.unsplash.com/photo-1547592166-23ac45744acd?w=200&h=200&fit=crop" },
       { id: 205, day: 2, time: "18:00", activity: "ä½å®¿ï¼šThe Milk Factory", tag: "hotel", image: "https://images.unsplash.com/photo-1566073771259-6a8506099945?w=200&h=200&fit=crop" },
       { id: 206, day: 2, time: "19:30", activity: "æ™šé¤ï¼šKaffi Hornid", tag: "food", image: "https://images.unsplash.com/photo-1550966871-3ed3c47e2ce2?w=200&h=200&fit=crop" },
       { id: 301, day: 3, time: "08:30", activity: "ç‰›å¥¶å·¥å» æ—©é¤ & å‡ºç™¼", tag: "food", image: "https://images.unsplash.com/photo-1533089862017-ec329abb0511?w=200&h=200&fit=crop" },
       { id: 302, day: 3, time: "10:00", activity: "ğŸ“ å†°æ²³æ¹–è—æ´ä¹‹æ—… (Blue Ice Cave)", tag: "sightseeing", image: "https://images.unsplash.com/photo-1490735891913-40897cdaafd1?w=200&h=200&fit=crop" },
       { id: 303, day: 3, time: "13:00", activity: "åˆé¤ï¼šç•¶åœ°å°æ”¤è²©", tag: "food", image: "https://images.unsplash.com/photo-1504674900247-0877df9cc836?w=200&h=200&fit=crop" },
       { id: 304, day: 3, time: "14:30", activity: "JÃ¶kulsÃ¡rlÃ³n å†°æ²³æ¹–æ•£æ­¥", tag: "sightseeing", image: "https://images.unsplash.com/photo-1464822759023-fed622ff2c3b?w=200&h=200&fit=crop" },
       { id: 305, day: 3, time: "18:00", activity: "æ™šé¤ï¼šPakkhÃºs (å¿…åƒé¾è¦é¤ ğŸ¦)", tag: "food", image: "https://images.unsplash.com/photo-1559339352-11d035aa65de?w=200&h=200&fit=crop" },
       { id: 306, day: 3, time: "20:00", activity: "ä½å®¿ï¼šThe Milk Factory (çœ‹æ¥µå…‰!)", tag: "hotel", image: "https://images.unsplash.com/photo-1483347752467-85239967961c?w=200&h=200&fit=crop" },
       { id: 401, day: 4, time: "09:00", activity: "æ—©é¤ & Check-out", image: "https://images.unsplash.com/photo-1493770348161-369560ae357d?w=200&h=200&fit=crop" },
       { id: 402, day: 4, time: "11:00", activity: "FjaÃ°rÃ¡rgljÃºfur ç¾½æ¯›æ²³å³½è°·", tag: "sightseeing", image: "https://images.unsplash.com/photo-1504829857797-ddff29c27927?w=200&h=200&fit=crop" },
       { id: 403, day: 4, time: "14:00", activity: "Seljalandsfoss æ°´ç°¾æ´ç€‘å¸ƒ", tag: "sightseeing", image: "https://images.unsplash.com/photo-1533423793766-26156e54589d?w=200&h=200&fit=crop" },
       { id: 404, day: 4, time: "17:00", activity: "ä½å®¿ï¼šAudur Guesthouse", tag: "hotel", image: "https://images.unsplash.com/photo-1522708323590-d24dbb6b0267?w=200&h=200&fit=crop" },
       { id: 405, day: 4, time: "19:00", activity: "æ™šé¤ï¼šIcelandic Street Food (éºµåŒ…æ¹¯)", tag: "food", image: "https://images.unsplash.com/photo-1588166524941-3bf61a9c41db?w=200&h=200&fit=crop" },
       { id: 501, day: 5, time: "09:30", activity: "é»ƒé‡‘åœˆä¸€æ—¥éŠ (Golden Circle)", tag: "sightseeing", image: "https://images.unsplash.com/photo-1476610182048-b716b8518aae?w=200&h=200&fit=crop" },
       { id: 502, day: 5, time: "15:00", activity: "Blue Lagoon è—æ¹–æº«æ³‰ â™¨ï¸", tag: "sightseeing", image: "https://images.unsplash.com/photo-1533285785082-d2789182d334?w=200&h=200&fit=crop" },
       { id: 503, day: 5, time: "19:00", activity: "æ™šé¤ï¼šSeabaron (çƒ¤è‚‰ä¸²/é¾è¦æ¹¯)", tag: "food", image: "https://images.unsplash.com/photo-1600891964092-4316c288032e?w=200&h=200&fit=crop" },
       { id: 504, day: 5, time: "21:00", activity: "ä½å®¿ï¼šAudur Guesthouse", tag: "hotel", image: "https://images.unsplash.com/photo-1531366936337-7c912a4589a7?w=200&h=200&fit=crop" },
       { id: 601, day: 6, time: "10:00", activity: "é›·å…‹é›…ç¶­å…‹å¤§æ•™å ‚", tag: "sightseeing", image: "https://images.unsplash.com/photo-1555543714-36528d228c29?w=200&h=200&fit=crop" },
       { id: 602, day: 6, time: "12:00", activity: "åˆé¤ï¼šå¸‚å€ç†±ç‹—æ”¤", tag: "food", image: "https://images.unsplash.com/photo-1620898583487-160e1d156161?w=200&h=200&fit=crop" },
       { id: 603, day: 6, time: "14:00", activity: "Sky Lagoon å¤©ç©ºä¹‹æ¹–", tag: "sightseeing", image: "https://images.unsplash.com/photo-1515658323427-4b5314eb4e13?w=200&h=200&fit=crop" },
       { id: 604, day: 6, time: "17:00", activity: "æ•™å ‚å±± (Kirkjufell) / çœ‹æµ·è±¹", tag: "sightseeing", image: "https://images.unsplash.com/photo-1504893524553-bfe206dd8e96?w=200&h=200&fit=crop" },
       { id: 605, day: 6, time: "20:00", activity: "æ™šé¤ï¼šæ²’æ±è¥¿åƒå„è‡ªä¿å‘½ ğŸ˜‚", tag: "food", image: "https://images.unsplash.com/photo-1465311440653-ba3208f4c759?w=200&h=200&fit=crop" },
       { id: 606, day: 6, time: "22:00", activity: "ä½å®¿ï¼šAudur Guesthouse", tag: "hotel", image: "https://images.unsplash.com/photo-1482355347028-ff6de45d0117?w=200&h=200&fit=crop" },
       { id: 701, day: 7, time: "09:00", activity: "æ•´ç†è¡Œæ & é€€æˆ¿", image: "https://images.unsplash.com/photo-1582719478250-c89cae4dc85b?w=200&h=200&fit=crop" },
       { id: 702, day: 7, time: "11:00", activity: "å‰å¾€æ©Ÿå ´é‚„è»Š", image: "https://images.unsplash.com/photo-1506012787146-f92b2d7d6d96?w=200&h=200&fit=crop" },
       { id: 703, day: 7, time: "14:00", activity: "KEF âœˆï¸ HKG (å›ç¨‹èˆªç­)", tag: "flight", image: "https://images.unsplash.com/photo-1542296332-2e44a996aa0d?w=200&h=200&fit=crop" },
       { id: 704, day: 7, time: "23:55", activity: "æ©Ÿä¸Šä¼‘æ¯ / è½‰æ©Ÿ", image: "https://images.unsplash.com/photo-1527634311077-9943f7be34e6?w=200&h=200&fit=crop" },
       { id: 801, day: 8, time: "18:00", activity: "æŠµé”é¦™æ¸¯ HKG è½‰æ©Ÿå›å°ç£", tag: "flight", image: "https://images.unsplash.com/photo-1506318164473-2dfd3ede3623?w=200&h=200&fit=crop" },
       { id: 802, day: 8, time: "20:30", activity: "æŠµé”å°ç£æº«æš–çš„å®¶ ğŸ‡¹ğŸ‡¼", tag: "flight", image: "https://images.unsplash.com/photo-1509356843151-3e7d96241e11?w=200&h=200&fit=crop" }
    ];

    let appState = {
        title: DEFAULT_TITLE,
        banner: DEFAULT_BANNER,
        totalDays: 5,
        plans: JSON.parse(JSON.stringify(defaultItinerary))
    };

    let currentViewDay = 'all'; 
    let isLocked = true; 
    let sortables = []; 
    let sidebarSortable = null;

    window.addEventListener('firebase-ready', async () => {
        const modules = window.firebaseModules;
        db = modules.db;
        auth = modules.auth;
        await modules.signInAnonymously(auth);
        modules.onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                await initTrip();
            }
        });
    });

    // å¯¦ä½œç¼ºå°‘çš„ hideLoading å‡½å¼
    function hideLoading() {
        const overlay = document.getElementById('loading-overlay');
        if(overlay) overlay.style.display = 'none';
    }

    // å¯¦ä½œç¼ºå°‘çš„ updateTripHistory å‡½å¼
    function updateTripHistory(id, title) {
        let history = JSON.parse(localStorage.getItem(STORAGE_KEY_TRIPS) || '[]');
        history = history.filter(trip => trip.id !== id);
        history.unshift({ id, title, timestamp: Date.now() });
        if (history.length > 20) history = history.slice(0, 20);
        localStorage.setItem(STORAGE_KEY_TRIPS, JSON.stringify(history));
    }

    async function initTrip() {
        const { doc, getDoc, setDoc } = window.firebaseModules;
        
        const urlParams = new URLSearchParams(window.location.search);
        let idFromUrl = urlParams.get('trip');

        if (!idFromUrl && typeof PRESET_TRIP_ID !== 'undefined' && PRESET_TRIP_ID) {
            idFromUrl = PRESET_TRIP_ID;
        }

        if (!idFromUrl) {
            const history = getTripHistory();
            if (history.length > 0) {
                idFromUrl = history[0].id; // å–æœ€è¿‘ä¸€ç­†
                try {
                    const newUrl = `${window.location.pathname}?trip=${idFromUrl}`;
                    window.history.replaceState({path:newUrl}, '', newUrl);
                } catch(e) {}
            }
        }

        tripId = idFromUrl;

        if (!tripId) {
            tripId = crypto.randomUUID().substring(0, 8);
            try {
                const newUrl = `${window.location.pathname}?trip=${tripId}`;
                window.history.pushState({path:newUrl}, '', newUrl);
            } catch (e) { console.warn("Preview Mode: URL history update skipped."); }
            await saveToCloud(true);
            updateTripHistory(tripId, appState.title); 
            hideLoading();
            renderUI();
        } else {
            try {
                const docRef = doc(db, 'public_trips', tripId);
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    appState = { ...appState, ...data };
                    if (!appState.plans) appState.plans = [];
                    updateTripHistory(tripId, appState.title); 
                } else {
                    await saveToCloud(true);
                    updateTripHistory(tripId, appState.title); 
                }
            } catch (e) {
                console.error("Load Error:", e);
                alert("è®€å–å¤±æ•—ï¼Œè«‹ç¢ºèª Firebase é€£ç·šã€‚");
            } finally {
                hideLoading();
                renderUI();
            }
        }
    }

    function getTripHistory() {
        return JSON.parse(localStorage.getItem(STORAGE_KEY_TRIPS) || '[]');
    }

    function autoSave() {
        if (saveTimeout) clearTimeout(saveTimeout);
        saveTimeout = setTimeout(() => saveToCloud(), 1000);
    }

    async function saveToCloud(force = false) {
        if (!currentUser || !tripId) return;
        const { doc, setDoc } = window.firebaseModules;
        try {
            await setDoc(doc(db, 'public_trips', tripId), appState);
            await setDoc(doc(db, 'public_trips_meta', tripId), {
                id: tripId,
                title: appState.title,
                updatedAt: Date.now()
            }, { merge: true });
            console.log("Cloud Saved");
        } catch (e) { 
            console.error("Save Error:", e); 
            if (e.code === 'permission-denied' || e.message.includes('permissions')) {
                alert("âš ï¸ å„²å­˜å¤±æ•—ï¼šæ¬Šé™ä¸è¶³ï¼Œè«‹æª¢æŸ¥ Firebase Rulesã€‚");
            }
        }
    }

    function updateMap(queryOverride) {
        const frame = document.getElementById('googleMapFrame');
        let query = queryOverride || appState.title;
        if (!queryOverride && currentViewDay !== 'all') {
            const dayPlans = appState.plans.filter(p => p.day == currentViewDay);
            if (dayPlans.length > 0) {
                query = dayPlans[0].activity;
            }
        }
        query = query.replace(/([\u2700-\u27BF]|[\uE000-\uF8FF]|\uD83C[\uDC00-\uDFFF]|\uD83D[\uDC00-\uDFFF]|[\u2011-\u26FF]|\uD83E[\uDD10-\uDDFF])/g, '').trim();
        frame.src = `https://maps.google.com/maps?q=${encodeURIComponent(query)}&t=&z=13&ie=UTF8&iwloc=&output=embed`;
    }

    function openFullMapRoute() {
        let locations = [];
        if (currentViewDay === 'all') {
             const days = {};
             appState.plans.forEach(p => {
                 if (!days[p.day]) days[p.day] = p.activity;
             });
             locations = Object.values(days);
        } else {
            const dayPlans = appState.plans.filter(p => p.day == currentViewDay);
            dayPlans.sort((a,b) => a.time.localeCompare(b.time));
            locations = dayPlans.map(p => p.activity);
        }

        if (locations.length === 0) return alert("ç›®å‰æ²’æœ‰è¡Œç¨‹åœ°é»å¯è¦åŠƒè·¯ç·š");
        const cleanLocs = locations.map(l => l.replace(/([\u2700-\u27BF]|[\uE000-\uF8FF]|\uD83C[\uDC00-\uDFFF]|\uD83D[\uDC00-\uDFFF]|[\u2011-\u26FF]|\uD83E[\uDD10-\uDDFF])/g, '').trim());
        const mapUrl = `https://www.google.com/maps/dir/${cleanLocs.map(encodeURIComponent).join('/')}`;
        window.open(mapUrl, '_blank');
    }

    // --- Render Logic ---
    function renderUI() {
        renderHeader();
        renderSidebar();
        renderDaySelect();
        renderAllPlans();
        applyLockState(); 
        updateMap(); 
    }

    // â˜…â˜…â˜… è£œå›ç¼ºå¤±çš„ renderHeader ç­‰å‡½å¼ â˜…â˜…â˜…

    function renderHeader() {
        document.getElementById('mainTitle').innerText = appState.title;
        document.getElementById('bannerImg').src = appState.banner;
        document.title = appState.title; // æ›´æ–°é ç±¤åç¨±
    }

    function editTitle(e) {
        if(isLocked) return;
        e.stopPropagation();
        const newTitle = prompt("è«‹è¼¸å…¥æ–°çš„æ¨™é¡Œ:", appState.title);
        if (newTitle && newTitle.trim() !== "") {
            appState.title = newTitle;
            renderHeader();
            autoSave();
        }
    }

    function editBanner() {
        if(isLocked) return;
        const newBanner = prompt("è«‹è¼¸å…¥æ–°çš„å°é¢åœ–ç‰‡ç¶²å€:", appState.banner);
        if (newBanner && newBanner.trim() !== "") {
            appState.banner = newBanner;
            renderHeader();
            autoSave();
        }
    }

    function switchView(day) {
        currentViewDay = day;
        renderSidebar();
        renderAllPlans();
        if (day !== 'all') document.getElementById('dayInput').value = day;
        updateMap(); // åˆ‡æ›å¤©æ•¸æ›´æ–°åœ°åœ–
    }

    function renderDaySelect() {
        const select = document.getElementById('dayInput');
        const currentVal = select.value;
        select.innerHTML = '';
        for (let i = 1; i <= appState.totalDays; i++) {
            const option = document.createElement('option');
            option.value = i;
            option.textContent = `Day ${i}`;
            select.appendChild(option);
        }
        if (currentVal && currentVal <= appState.totalDays) select.value = currentVal;
    }

    function changeTotalDays(delta) {
        if(isLocked) return;
        const newTotal = appState.totalDays + delta;
        if (newTotal < 1 || newTotal > 30) return alert("å¤©æ•¸è«‹åœ¨ 1~30 ä¹‹é–“");
        if (delta < 0) {
            const hasPlans = appState.plans.some(p => p.day === appState.totalDays);
            if (hasPlans && !confirm(`Day ${appState.totalDays} é‚„æœ‰è¡Œç¨‹ï¼Œç¢ºå®šåˆªé™¤ï¼Ÿ`)) return;
            if (hasPlans) appState.plans = appState.plans.filter(p => p.day !== appState.totalDays);
        }
        appState.totalDays = newTotal;
        renderSidebar(); renderDaySelect();
        if (typeof currentViewDay === 'number' && currentViewDay > appState.totalDays) switchView('all');
        autoSave();
    }

    function renderSidebar() {
        const sidebarList = document.getElementById('daySidebarList');
        sidebarList.innerHTML = '';
        if (sidebarSortable) { sidebarSortable.destroy(); sidebarSortable = null; }

        const allBtn = document.getElementById('btn-all');
        if (currentViewDay === 'all') allBtn.classList.add('active');
        else allBtn.classList.remove('active');

        for (let i = 1; i <= appState.totalDays; i++) {
            const btn = document.createElement('button');
            btn.className = `sidebar-btn ${currentViewDay == i ? 'active' : ''}`;
            btn.textContent = `Day ${i}`;
            btn.setAttribute('data-origin-day', i);
            btn.onclick = () => switchView(i);
            sidebarList.appendChild(btn);
        }

        sidebarSortable = new Sortable(sidebarList, {
            group: 'sidebar-days', animation: 150,
            ghostClass: 'sidebar-sortable-ghost', dragClass: 'sidebar-sortable-drag',
            disabled: isLocked, delay: 100, delayOnTouchOnly: true,
            onEnd: function (evt) { if (evt.oldIndex !== evt.newIndex) reorderDaysFromSidebar(); }
        });
    }

    function reorderDaysFromSidebar() {
        const sidebarList = document.getElementById('daySidebarList');
        const buttons = Array.from(sidebarList.children);
        const dayMapping = {};
        buttons.forEach((btn, index) => {
            const oldDay = parseInt(btn.getAttribute('data-origin-day'));
            dayMapping[oldDay] = index + 1;
        });
        appState.plans = appState.plans.map(plan => {
            if (dayMapping[plan.day]) return { ...plan, day: dayMapping[plan.day] };
            return plan;
        });
        if (currentViewDay !== 'all') currentViewDay = dayMapping[currentViewDay];
        renderSidebar(); renderAllPlans(); autoSave();
    }

    function renderAllPlans() {
        const container = document.getElementById('timeline-container');
        container.innerHTML = '';
        sortables.forEach(s => s.destroy()); sortables = [];
        
        let displayPlans = appState.plans;
        if (currentViewDay !== 'all') displayPlans = appState.plans.filter(p => p.day == currentViewDay);
        
        displayPlans.sort((a, b) => (a.day - b.day) || a.time.localeCompare(b.time));
        const grouped = displayPlans.reduce((acc, curr) => { (acc[curr.day] = acc[curr.day] || []).push(curr); return acc; }, {});
        const days = Object.keys(grouped).sort((a,b) => a-b);
        
        if (currentViewDay !== 'all' && days.length === 0) { days.push(currentViewDay); grouped[currentViewDay] = []; }
        else if (days.length === 0 && appState.plans.length === 0) {
            container.innerHTML = `<div style="text-align:center; color:#999; margin-top:50px;">ç›®å‰æ²’æœ‰è¡Œç¨‹</div>`;
            return;
        }

        days.forEach(day => {
            const section = document.createElement('div');
            section.className = 'day-section';
            section.innerHTML = `<div class="day-header"><span class="day-badge">Day ${day}</span></div>`;
            const listContainer = document.createElement('div');
            listContainer.className = 'plan-list-container';
            listContainer.setAttribute('data-day', day);
            
            if (grouped[day]) grouped[day].forEach(plan => listContainer.appendChild(createPlanItem(plan)));
            section.appendChild(listContainer);
            container.appendChild(section);

            if (!isLocked) {
                const sortable = new Sortable(listContainer, {
                    group: 'shared', animation: 150,
                    ghostClass: 'sortable-ghost', dragClass: 'sortable-drag', handle: '.plan-item',
                    delay: 100, delayOnTouchOnly: true,
                    onEnd: function () { saveDragOrder(); }
                });
                sortables.push(sortable);
            }
        });
    }

    function createPlanItem(plan) {
        const item = document.createElement('div');
        item.className = 'plan-item';
        item.setAttribute('data-id', plan.id);
        
        let tagHtml = '', tagClass = 'tag-none', tagText = '(ç„¡æ¨™ç±¤)';
        if (plan.tag === 'flight') { tagClass = 'tag-flight'; tagText = 'âœˆï¸ èˆªç­'; }
        else if (plan.tag === 'hotel') { tagClass = 'tag-hotel'; tagText = 'ğŸ¨ ä½å®¿'; }
        else if (plan.tag === 'food') { tagClass = 'tag-food'; tagText = 'ğŸ½ï¸ ç¾é£Ÿ'; }
        else if (plan.tag === 'sightseeing') { tagClass = 'tag-sightseeing'; tagText = 'ğŸ”ï¸ æ™¯é»'; }
        
        if (!isLocked || (plan.tag && plan.tag !== '')) {
             tagHtml = `<span class="tag-base ${tagClass}" onclick="event.stopPropagation(); editTag(${plan.id})" title="${isLocked ? '' : 'é»æ“Šåˆ‡æ›æ¨™ç±¤'}">${tagText}</span>`;
        }

        let imgHtml = '';
        const clickAction = `event.stopPropagation(); handleImageClick(${plan.id}, '${plan.image || ''}')`;
        const onErr = `this.style.display='none'; if(document.body.classList.contains('locked-mode')){ this.parentNode.style.display='none'; } else { this.nextElementSibling.style.display='flex'; }`;

        if (plan.image && plan.image.trim() !== "") {
            imgHtml = `<div class="img-container" onclick="${clickAction}" title="${isLocked?'':'é»æ“Šä¿®æ”¹'}"><img src="${plan.image}" class="plan-img" onerror="${onErr}"><div class="img-placeholder" style="display:none">ï¼‹åœ–ç‰‡</div><span class="edit-hint">ğŸ“·</span></div>`;
        } else if (!isLocked) {
            imgHtml = `<div class="img-container img-empty" onclick="${clickAction}" title="é»æ“Šæ–°å¢"><div class="img-placeholder">ï¼‹åœ–ç‰‡</div></div>`;
        }
        
        const hasNoteClass = (plan.note && plan.note.trim() !== "") ? "has-note" : "";
        const timeTitle = isLocked ? "" : "é»æ“Šä¿®æ”¹æ™‚é–“";

        item.innerHTML = `
            <div class="plan-main">
                <div class="plan-content" onclick="updateMap('${plan.activity.replace(/'/g, "\\'")}')" title="é»æ“Šåœ¨åœ°åœ–é¡¯ç¤º">
                    <span class="plan-time" onclick="event.stopPropagation(); editTime(${plan.id})" title="${timeTitle}">${plan.time}</span>
                    <div class="plan-details">
                        <h3 class="editable-text" onclick="event.stopPropagation(); editActivity(${plan.id})" title="é»æ“Šä¿®æ”¹æ–‡å­—">${plan.activity}</h3>
                        <div class="plan-meta">
                            ${tagHtml}
                            <button id="note-btn-${plan.id}" class="note-toggle-btn ${hasNoteClass}" onclick="event.stopPropagation(); toggleNote(${plan.id})">ğŸ“ å‚™è¨»</button>
                        </div>
                    </div>
                </div>
                ${imgHtml}
                <button class="delete-btn" onclick="event.stopPropagation(); deletePlan(${plan.id})">&times;</button>
            </div>
            <div id="note-area-${plan.id}" class="plan-note-area">
                <textarea class="note-textarea" placeholder="å‚™è¨»..." onchange="saveNote(${plan.id}, this)">${plan.note || ''}</textarea>
            </div>`;
        return item;
    }

    function saveDragOrder() {
        const newPlans = [];
        document.querySelectorAll('.plan-list-container').forEach(container => {
            const day = parseInt(container.getAttribute('data-day'));
            container.querySelectorAll('.plan-item').forEach(item => {
                const id = parseInt(item.getAttribute('data-id'));
                const original = appState.plans.find(p => p.id === id);
                if (original) { original.day = day; newPlans.push(original); }
            });
        });
        if (currentViewDay !== 'all') {
            const hidden = appState.plans.filter(p => p.day != currentViewDay);
            newPlans.push(...hidden);
        }
        appState.plans = newPlans;
        autoSave();
        updateMap();
    }

    // --- Actions ---
    function toggleLock() {
        const { ADMIN_PASSWORD } = window.firebaseModules;
        if (!isLocked) { isLocked = true; applyLockState(); return; }
        const input = prompt("ğŸ”’ è«‹è¼¸å…¥ç®¡ç†å“¡å¯†ç¢¼ï¼š");
        if (input === ADMIN_PASSWORD) { isLocked = false; applyLockState(); showToast("ğŸ”“ ç·¨è¼¯æ¨¡å¼å·²å•Ÿç”¨"); } 
        else if (input !== null) { alert("âŒ å¯†ç¢¼éŒ¯èª¤"); }
    }

    function applyLockState() {
        const body = document.body;
        const lockBtn = document.getElementById('lockBtn');
        const lockIcon = document.getElementById('lockIcon');
        const lockText = document.getElementById('lockText');
        if (isLocked) {
            body.classList.add('locked-mode'); lockBtn.classList.add('active');
            lockIcon.textContent = 'ğŸ”’'; lockText.textContent = 'æª¢è¦–ä¸­ (å”¯è®€)';
            if (sidebarSortable) sidebarSortable.option("disabled", true);
            if (sortables) sortables.forEach(s => s.option("disabled", true));
        } else {
            body.classList.remove('locked-mode'); lockBtn.classList.remove('active');
            lockIcon.textContent = 'ğŸ”“'; lockText.textContent = 'ç·¨è¼¯ä¸­';
            if (sidebarSortable) sidebarSortable.option("disabled", false);
            if (sortables) sortables.forEach(s => s.option("disabled", false));
        }
        renderAllPlans();
        if(document.getElementById('tripListModal').style.display === 'flex') renderTripListModal();
    }

    function addPlan() {
        if(isLocked) return;
        const day = document.getElementById('dayInput').value;
        const time = document.getElementById('timeInput').value;
        const tag = document.getElementById('tagInput').value;
        const activity = document.getElementById('activityInput').value;
        if (!time || !activity) return alert("è«‹è¼¸å…¥æ™‚é–“å’Œå…§å®¹");
        appState.plans.push({ id: Date.now(), day: parseInt(day), time, activity, tag, image: "", note: "" });
        if (currentViewDay !== 'all' && currentViewDay != day) switchView(parseInt(day));
        else renderAllPlans();
        document.getElementById('activityInput').value = '';
        autoSave();
        updateMap();
    }

    function deletePlan(id) {
        if(isLocked) return;
        if(confirm('åˆªé™¤æ­¤è¡Œç¨‹ï¼Ÿ')) {
            appState.plans = appState.plans.filter(p => p.id !== id);
            renderAllPlans();
            autoSave();
            updateMap();
        }
    }

    function clearAllPlans() {
        if(isLocked) return;
        if(confirm("ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰è¡Œç¨‹å—ï¼Ÿ")) {
            appState.plans = [];
            appState.totalDays = 1;
            renderSidebar(); renderDaySelect(); switchView('all');
            autoSave();
            updateMap();
        }
    }

    async function createNewTrip() {
        if(isLocked) return alert("è«‹å…ˆè§£é–ä»¥å»ºç«‹æ–°è¡Œç¨‹");

        if(confirm("ç¢ºå®šè¦å»ºç«‹ä¸€å€‹æ–°çš„ç©ºç™½è¡Œç¨‹å—ï¼Ÿ\n(å°‡æœƒç”¢ç”Ÿæ–°çš„ç¶²å€ ID)")) {
            // 1. ç”¢ç”Ÿæ–° ID
            tripId = crypto.randomUUID().substring(0, 8);
            
            // 2. æ›´æ–°ç¶²å€ (ä¸åˆ·æ–°é é¢)
            try {
                const newUrl = `${window.location.pathname}?trip=${tripId}`;
                window.history.pushState({path:newUrl}, '', newUrl);
            } catch(e) { console.warn("URL update skipped"); }
            
            // 3. è¨­å®šç‚ºã€Œç©ºç™½ç‹€æ…‹ã€ (æ¯”ç…§æ¸…é™¤è¡Œç¨‹)
            appState = {
                title: "æ–°çš„æ—…ç¨‹", 
                banner: DEFAULT_BANNER,
                totalDays: 1, 
                plans: [] 
            };
            
            // 4. é‡ç½® UI ç‹€æ…‹
            currentViewDay = 'all';
            
            // 5. å­˜æª”ä¸¦æ¸²æŸ“
            await saveToCloud(true);
            updateTripHistory(tripId, appState.title);
            renderUI();
            showToast("å·²å»ºç«‹æ–°è¡Œç¨‹ï¼âœ¨");
        }
    }

    function handleImageClick(id, currentUrl) {
        if (isLocked) { if(currentUrl) openModal(currentUrl); }
        else {
            const plan = appState.plans.find(p => p.id === id);
            const newUrl = prompt("åœ–ç‰‡ç¶²å€:", plan.image || "");
            if (newUrl !== null) { plan.image = newUrl.trim(); renderAllPlans(); autoSave(); }
        }
    }

    function editTime(id) {
        if(isLocked) return;
        const plan = appState.plans.find(p => p.id === id);
        const newTime = prompt("æ™‚é–“ (HH:MM):", plan.time);
        if (newTime) { plan.time = newTime; renderAllPlans(); autoSave(); }
    }

    function editActivity(id) {
        if(isLocked) return;
        const plan = appState.plans.find(p => p.id === id);
        const newTxt = prompt("è¡Œç¨‹å…§å®¹:", plan.activity);
        if (newTxt) { plan.activity = newTxt; renderAllPlans(); autoSave(); updateMap(); } 
    }

    function editTag(id) {
        if(isLocked) return;
        const tags = ['', 'sightseeing', 'flight', 'hotel', 'food'];
        const plan = appState.plans.find(p => p.id === id);
        const idx = tags.indexOf(plan.tag || '');
        plan.tag = tags[(idx + 1) % tags.length];
        renderAllPlans(); autoSave();
    }

    function toggleNote(id) {
        const plan = appState.plans.find(p => p.id === id);
        if (isLocked && (!plan || !plan.note)) return;
        const area = document.getElementById(`note-area-${id}`);
        area.style.display = (area.style.display === 'none' || area.style.display === '') ? 'block' : 'none';
    }

    function saveNote(id, textarea) {
        const plan = appState.plans.find(p => p.id === id);
        if (plan) { plan.note = textarea.value; autoSave(); }
    }

    function openModal(url) { document.getElementById('imageModal').style.display = "flex"; document.getElementById('modalImg').src = url; }
    function closeModal() { document.getElementById('imageModal').style.display = "none"; }

    function resetDefault() {
        if(isLocked) return;
        if(confirm('é‡ç½®å›é è¨­è¡Œç¨‹ï¼Ÿ')) {
            appState.title = DEFAULT_TITLE;
            appState.banner = DEFAULT_BANNER;
            appState.totalDays = 8;
            appState.plans = JSON.parse(JSON.stringify(defaultItinerary));
            renderHeader(); renderSidebar(); renderDaySelect(); switchView('all');
            autoSave();
            updateMap();
        }
    }

    function shareTrip() {
        let url = window.location.href;
        if (!url.includes('trip=') && tripId) {
            const separator = url.includes('?') ? '&' : '?';
            url = `${url}${separator}trip=${tripId}`;
        }
        const textToCopy = `${appState.title}\n${url}`;
        if (navigator.clipboard && window.isSecureContext) {
            navigator.clipboard.writeText(textToCopy).then(() => showToast("å·²è¤‡è£½é€£çµèˆ‡æ¨™é¡Œï¼ğŸ”—"));
        } else {
            prompt("è¤‡è£½ç¶²å€:", url);
        }
    }
    
    // --- Trip List Logic ---
    async function renderTripListModal() {
        const listEl = document.getElementById('myTripList');
        listEl.innerHTML = '<li style="padding:15px; text-align:center; color:#666;">è¼‰å…¥ä¸­... â˜ï¸</li>';
        try {
            const { collection, query, orderBy, limit, getDocs } = window.firebaseModules;
            const q = query(collection(db, 'public_trips_meta'), orderBy('updatedAt', 'desc'), limit(20));
            const querySnapshot = await getDocs(q);
            listEl.innerHTML = '';
            if (querySnapshot.empty) { listEl.innerHTML = '<li style="padding:15px; text-align:center; color:#999;">ç›®å‰æ²’æœ‰ä»»ä½•å…¬é–‹è¡Œç¨‹</li>'; return; }
            querySnapshot.forEach((doc) => {
                const trip = doc.data();
                const li = document.createElement('li');
                li.className = 'trip-item';
                const isCurrent = (trip.id === tripId);
                const currentTag = isCurrent ? '<span class="current-trip-tag">ç›®å‰</span>' : '';
                const bgStyle = isCurrent ? 'background-color: #f0f9ff;' : '';
                const date = new Date(trip.updatedAt).toLocaleDateString();
                li.style = bgStyle;
                li.innerHTML = `<div class="trip-link" onclick="location.href='?trip=${trip.id}'"><div style="display:flex; flex-direction:column;"><span>${trip.title || 'æœªå‘½åè¡Œç¨‹'} ${currentTag}</span><span style="font-size:0.75rem; color:#b2bec3; font-weight:normal;">${date}</span></div></div>${isLocked ? '' : `<span class="trip-delete" onclick="deleteTripFromCloud('${trip.id}')" title="æ°¸ä¹…åˆªé™¤">&times;</span>`}`;
                listEl.appendChild(li);
            });
        } catch (e) {
            console.error("List Error:", e);
            listEl.innerHTML = '<li style="padding:15px; text-align:center; color:red;">è®€å–å¤±æ•—</li>';
        }
    }
    function openTripListModal() { document.getElementById('tripListModal').style.display = 'flex'; renderTripListModal(); }
    function closeTripListModal() { document.getElementById('tripListModal').style.display = 'none'; }
    async function deleteTripFromCloud(id) {
        if(isLocked) return;
        if(!confirm("é€™å°‡æœƒå¾é›²ç«¯ã€Œæ°¸ä¹…åˆªé™¤ã€æ­¤è¡Œç¨‹ï¼Œæ‰€æœ‰äººéƒ½ç„¡æ³•å†çœ‹åˆ°ï¼Œç¢ºå®šå—ï¼Ÿ")) return;
        try {
            const { deleteDoc, doc } = window.firebaseModules;
            await deleteDoc(doc(db, 'public_trips_meta', id));
            await deleteDoc(doc(db, 'public_trips', id));
            renderTripListModal();
        } catch(e) { alert("åˆªé™¤å¤±æ•—ï¼š" + e.message); }
    }
</script>
</body>
</html>
